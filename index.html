<html>

<head>
    <title>transformers-js</title>
    <style>
        textarea { padding: 0.25em 0.25em; }
        #input { font-family: Papyrus, sans-serif; font-size: 32px; }
        #output { font-family: monospace; font-size: 32px; }
    </style>
</head>

<body>
    <h1>transformers-js</h1>
    <nav>
        <p><a href="/test">Test Tokenizers</a></p>
    </nav>

    <h2>Translation Demo</h2>
    <p>This demo uses the t5-small neural network.</p>
    <form style="width:50em;display:block;" onsubmit="translateInput(event)">
        <p><b>Status</b> <span id="status">Loading...</span></p>
        <h3><label for="prefix">Input</label></h3>
        <p><input type="text" id="prefix" name="prefix" value="translate English to French:" style="width: 100%;" /></p>
        <textarea id="input" name="input" rows="3" style="width: 100%;" oninput="onInputChanged(event)">The universe is a dark forest.</textarea>
        <p id="inputDebug"></p>
        <h3><label for="output">Output</label></h3>
        <textarea id="output" name="output" rows="4" style="width: 100%;"></textarea>
        <p id="outputDebug"></p>
        <p><input type="submit" value="Generate"></p>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.js"></script>
    <script src="src/tokenizers.js"></script>
    <script src="src/transformers.js"></script>
    <script type="text/javascript">

        const $status = document.getElementById("status");
        const $prefix = document.getElementById("prefix");
        const $input = document.getElementById("input");
        const $output = document.getElementById("output");
        const $inputDebug = document.getElementById("inputDebug");
        const $outputDebug = document.getElementById("outputDebug");

        let tokenizer = null;
        let model = null;

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function onInputChanged(e) {
            if (e) e.preventDefault();
            // Throttle calls to translateInput
            if (window.translateInputTimeout) {
                clearTimeout(window.translateInputTimeout);
            }
            window.translateInputTimeout = setTimeout(translateInput, 1000);
        }
        
        async function translateInput(e) {
            if (e) e.preventDefault();
            if (tokenizer !== null && model !== null) {
                $status.innerText = "Translating...";
                await delay(100); // Give the UI a chance to update.
                const input = $prefix.value.trim() + " " + $input.value.trim();
                const inputTokenIds = tokenizer.encode(input);
                $inputDebug.innerText = inputTokenIds.join(" ");
                const outputTokens = await model.generate(inputTokenIds, 140);
                $outputDebug.innerText = outputTokens.join(" ");
                $output.value = tokenizer.decode(outputTokens, true).trim();
                $status.innerText = "Ready";
            }
            else {
                $inputDebug.innerText = "Loading...";
                $outputDebug.innerText = "Loading...";
                $output.value = "";
            }
        }

        async function main() {
            tokenizer = await AutoTokenizer.fromPretrained("t5-small", "/models");
            console.log(tokenizer);
            model = await AutoModelForSeq2SeqLM.fromPretrained("t5-small", "/models", async function(progress) {
                $status.innerText = `Loading the neural network... ${Math.round(progress * 100)}%`;
                await delay(100); // Give the UI a chance to update.
            });
            console.log(model);
            $status.innerText = `Ready`;
            translateInput(null);
        }

        main();

    </script>
</body>

</html>